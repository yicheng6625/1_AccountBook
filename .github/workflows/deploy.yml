# GitHub Actions CI/CD 部署流程
# 原因：自動化編譯、建置 Docker 映像並部署到伺服器

name: CI/CD Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允許手動觸發

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========== 階段一：編譯 Go 後端 ==========
  build:
    name: Build Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 程式碼
        uses: actions/checkout@v4

      - name: 設定 Go 環境
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: backend/go.sum

      - name: 下載 Go 依賴
        working-directory: ./backend
        run: go mod download

      - name: 編譯後端執行檔
        working-directory: ./backend
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o accountbook-server .
          chmod +x accountbook-server

      - name: 上傳編譯產物
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/accountbook-server
          retention-days: 1

  # ========== 階段二：建置並推送 Docker 映像 ==========
  docker:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout 程式碼
        uses: actions/checkout@v4

      - name: 下載後端編譯產物
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: backend/

      - name: 設定執行權限
        run: chmod +x backend/accountbook-server

      - name: 設定 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登入 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 擷取 Docker metadata（後端）
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: 建置並推送後端映像
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          platforms: linux/arm64

      - name: 擷取 Docker metadata（前端）
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: 建置並推送前端映像
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          platforms: linux/arm64

  # ========== 階段三：部署到伺服器 ==========
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - name: Checkout 程式碼
        uses: actions/checkout@v4

      - name: 透過 SSH 部署到伺服器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            # 登入 GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 拉取最新映像
            docker pull ghcr.io/${{ github.repository }}/backend:latest
            docker pull ghcr.io/${{ github.repository }}/frontend:latest

            # 更新 docker-compose.yml 使用新映像（若有需要）
            # 重新啟動容器
            docker compose down
            docker compose up -d

            # 清理舊映像
            docker image prune -f

            echo "部署完成！"
